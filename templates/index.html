<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Plan Workload Visualizer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        #map { height: 100vh; width: 100vw; }
        .leaflet-control-container .leaflet-control { border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: 1px solid #ddd; }
        .info-legend { padding: 8px 12px; background: white; line-height: 1.5; font-size: 14px; color: #333; }
        .info-legend h4 { margin: 0 0 5px; font-weight: 600; color: #111; }
        .info-legend .legend-item { display: flex; align-items: center; margin-bottom: 2px; }
        .info-legend .legend-color-box { width: 18px; height: 18px; margin-right: 8px; border: 1px solid #ccc; opacity: 0.8; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="map"></div>

    <!-- UI Controls -->
    <div id="controls" class="leaflet-control-container">
        <div class="leaflet-top leaflet-right">
            <div class="leaflet-control leaflet-bar bg-white p-4 rounded-lg shadow-lg m-4 max-w-xs">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">Select View Level</h3>
                <div class="space-y-2" id="level-selector">
                    <!-- Radio buttons remain the same -->
                    <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="level" value="Region" class="form-radio text-blue-600" checked><span class="text-gray-700">Region</span></label>
                    <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="level" value="District" class="form-radio text-blue-600"><span class="text-gray-700">District</span></label>
                    <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="level" value="Territory" class="form-radio text-blue-600"><span class="text-gray-700">Territory</span></label>
                    <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="level" value="ZIP" class="form-radio text-blue-600"><span class="text-gray-700">ZIP Code</span></label>
                </div>

                <!-- NEW: Search Bar -->
                <hr class="my-4 border-gray-200">
                <h3 class="text-lg font-semibold mb-2 text-gray-800">Find Location</h3>
                <form id="search-form" class="flex items-center">
                    <input type="text" id="search-input" placeholder="Enter name or ZIP..." list="search-suggestions" class="flex-grow p-2 border border-gray-300 rounded-l-md text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <datalist id="search-suggestions"></datalist>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-r-md text-sm font-semibold hover:bg-blue-700 transition-colors">Find</button>
                </form>
                <div id="search-message" class="text-red-500 text-xs mt-1 h-4"></div>

                <div id="loading-indicator" class="hidden mt-4 text-center">
                     <div class="flex items-center justify-center space-x-2"><div class="w-4 h-4 rounded-full animate-pulse bg-blue-600"></div><div class="text-sm text-gray-600">Processing...</div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. INITIALIZATION ---
        const map = L.map('map').setView([39.8283, -98.5795], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
        }).addTo(map);

        let currentGeoJsonLayer = null;
        let legend = null;
        let searchableNames = {}; // NEW: To store all names for searching

        // --- 2. MAP VISUALIZATION LOGIC ---
        function getColor(props) {
            const { calls, threshold } = props;
            if (!threshold || threshold === 0) return '#FED976';
            return calls > threshold ? '#e53e3e' : '#48bb78';
        }
        function style(feature) { return { fillColor: getColor(feature.properties), weight: 1, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.75 }; }
        function highlightFeature(e) { e.target.setStyle({ weight: 3, color: '#4A5568', dashArray: '', fillOpacity: 0.8 }).bringToFront(); }
        function resetHighlight(e) { if (currentGeoJsonLayer) currentGeoJsonLayer.resetStyle(e.target); }

        async function updateMap() {
            const level = document.querySelector('input[name="level"]:checked').value;
            document.getElementById('loading-indicator').classList.remove('hidden');
            if (currentGeoJsonLayer) map.removeLayer(currentGeoJsonLayer);
            if (legend) map.removeControl(legend);

            try {
                const response = await fetch(`/data?level=${level}`);
                if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                const displayGeoJSON = await response.json();
                currentGeoJsonLayer = L.geoJson(displayGeoJSON, { style: style, onEachFeature: (feature, layer) => { 
                    layer.on({ mouseover: highlightFeature, mouseout: resetHighlight });
                    const props = feature.properties, levelName = document.querySelector('input[name="level"]:checked').value;
                    let popupContent = `<div class="font-sans text-sm"><strong class="text-base text-gray-800">${props.name}</strong><br><span class="text-gray-600">${levelName}</span><hr class="my-1.5"><div class="space-y-1"><div><span class="font-semibold">Workload (WL):</span> ${props.calls.toLocaleString()||0}</div><div><span class="font-semibold"># HCPs:</span> ${props.hcp_count.toLocaleString()||0}</div>`;
                    if (props.threshold > 0) { const isOver = props.calls > props.threshold, colorClass = isOver ? 'text-red-600' : 'text-green-600'; popupContent += `<div><span class="font-semibold">Threshold:</span> <span class="${colorClass} font-bold">${props.threshold.toLocaleString()}</span></div>`; }
                    popupContent += `</div></div>`;
                    layer.bindPopup(popupContent);
                }}).addTo(map);
                if (displayGeoJSON?.features.length > 0) { map.fitBounds(currentGeoJsonLayer.getBounds()); } else { map.setView([39.8283, -98.5795], 4); }
                addLegend();
            } catch (error) { console.error("Failed to load map data:", error); alert("Could not load map data."); } 
            finally { document.getElementById('loading-indicator').classList.add('hidden'); }
        }
        function addLegend() {
            legend = L.control({position: 'bottomright'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info-legend'), level = document.querySelector('input[name="level"]:checked').value;
                div.innerHTML += '<h4>Workload Status</h4>';
                if (level !== 'ZIP') { div.innerHTML += `<div class="legend-item"><i class="legend-color-box" style="background:#48bb78"></i><span>At or Below Threshold</span></div><div class="legend-item"><i class="legend-color-box" style="background:#e53e3e"></i><span>Over Threshold</span></div>`; } 
                else { div.innerHTML += `<div class="legend-item"><i class="legend-color-box" style="background:#FED976"></i><span>ZIP Code</span></div>`; }
                return div;
            };
            legend.addTo(map);
        }

        // --- 3. NEW SEARCH LOGIC ---

        // Fetch all names from the server on page load
        async function fetchSearchableNames() {
            try {
                const response = await fetch('/names');
                if (!response.ok) throw new Error('Server error fetching names');
                searchableNames = await response.json();
                
                // Populate the datalist for autocomplete suggestions
                const datalist = document.getElementById('search-suggestions');
                datalist.innerHTML = '';
                const allNames = [
                    ...searchableNames.region, 
                    ...searchableNames.district, 
                    ...searchableNames.territory, 
                    ...searchableNames.zip
                ];
                allNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    datalist.appendChild(option);
                });

            } catch (error) {
                console.error("Could not fetch searchable names:", error);
            }
        }

        // Handle the search form submission
        function handleSearch(event) {
            event.preventDefault(); // Prevent page reload
            const searchInput = document.getElementById('search-input');
            const messageDiv = document.getElementById('search-message');
            const searchTerm = searchInput.value.trim().toLowerCase();
            
            messageDiv.textContent = ''; // Clear previous messages
            if (!searchTerm) return;

            if (!currentGeoJsonLayer) {
                messageDiv.textContent = 'Map data not loaded yet.';
                return;
            }

            let foundLayer = null;
            // Iterate through the currently visible map layers
            currentGeoJsonLayer.eachLayer(layer => {
                const layerName = String(layer.feature.properties.name).toLowerCase();
                if (layerName === searchTerm) {
                    foundLayer = layer;
                }
            });

            if (foundLayer) {
                // If found, zoom to it and open its popup
                map.fitBounds(foundLayer.getBounds(), { maxZoom: 10, paddingTopLeft: [50, 50], paddingBottomRight: [50, 50] });
                foundLayer.openPopup();
                searchInput.value = ''; // Clear search bar
            } else {
                // If not found in the current view, tell the user
                messageDiv.textContent = 'Name not found in current view.';
            }
        }

        // --- 4. EVENT LISTENERS & INITIAL LOAD ---
        document.getElementById('level-selector').addEventListener('change', updateMap);
        document.getElementById('search-form').addEventListener('submit', handleSearch);
        
        // On page load, fetch the names first, then draw the initial map
        window.onload = async () => {
            await fetchSearchableNames();
            updateMap();
        };
    </script>
</body>
</html>

